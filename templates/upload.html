{% extends "base.html" %}

{% block title %}Upload & Process - PDF Processing Engine{% endblock %}

{% block content %}
<div class="container my-5">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('web.index') }}">Home</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('web.tools') }}">Tools</a></li>
                    <li class="breadcrumb-item active">Upload & Process</li>
                </ol>
            </nav>
            <h2 class="mb-1">Upload & Process PDFs</h2>
            <p class="text-muted">Select your operation and upload files to get started</p>
        </div>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="row">
        <!-- Operation Selection -->
        <div class="col-md-4">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i data-feather="settings" class="me-2"></i>Select Operation
                    </h5>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        <a href="#" class="list-group-item list-group-item-action operation-btn" data-operation="merge">
                            <div class="d-flex align-items-center">
                                <i data-feather="layers" class="me-3 text-primary"></i>
                                <div>
                                    <h6 class="mb-1">Merge PDFs</h6>
                                    <small class="text-muted">Combine multiple files</small>
                                </div>
                            </div>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action operation-btn" data-operation="split">
                            <div class="d-flex align-items-center">
                                <i data-feather="scissors" class="me-3 text-success"></i>
                                <div>
                                    <h6 class="mb-1">Split PDF</h6>
                                    <small class="text-muted">Extract specific pages</small>
                                </div>
                            </div>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action operation-btn" data-operation="convert">
                            <div class="d-flex align-items-center">
                                <i data-feather="image" class="me-3 text-warning"></i>
                                <div>
                                    <h6 class="mb-1">Convert to Images</h6>
                                    <small class="text-muted">PDF to PNG/JPEG</small>
                                </div>
                            </div>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action operation-btn" data-operation="compress">
                            <div class="d-flex align-items-center">
                                <i data-feather="minimize" class="me-3 text-danger"></i>
                                <div>
                                    <h6 class="mb-1">Compress PDF</h6>
                                    <small class="text-muted">Reduce file size</small>
                                </div>
                            </div>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action operation-btn" data-operation="metadata">
                            <div class="d-flex align-items-center">
                                <i data-feather="info" class="me-3 text-info"></i>
                                <div>
                                    <h6 class="mb-1">Extract Metadata</h6>
                                    <small class="text-muted">Get document info</small>
                                </div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Current User Info -->
            <div class="card border-0 shadow-sm">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i data-feather="user" class="me-2"></i>Account Info
                    </h6>
                </div>
                <div class="card-body">
                    <p class="small mb-2"><strong>User:</strong> {{ current_user.username }}</p>
                    <p class="small mb-2"><strong>API Key:</strong> <code class="small">{{ current_user.api_key[:16] }}...</code></p>
                    <a href="{{ url_for('auth.profile') }}" class="btn btn-sm btn-outline-secondary">
                        <i data-feather="settings" class="me-1"></i>Manage Account
                    </a>
                </div>
            </div>
        </div>

        <!-- Upload Interface -->
        <div class="col-md-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i data-feather="upload" class="me-2"></i>Upload Files
                    </h5>
                    <span id="operationBadge" class="badge bg-secondary">Select Operation</span>
                </div>
                <div class="card-body">
                    <!-- Operation-specific instructions -->
                    <div id="operationInstructions" class="alert alert-info mb-4" style="display: none;">
                        <div id="instructionContent"></div>
                    </div>

                    <!-- File Upload Area -->
                    <div id="uploadArea" class="border-2 border-dashed border-secondary rounded p-5 text-center mb-4">
                        <i data-feather="upload-cloud" style="width: 64px; height: 64px;" class="text-muted mb-3"></i>
                        <h5 class="text-muted">Drag & Drop PDF Files Here</h5>
                        <p class="text-muted mb-3">or click to browse</p>
                        <input type="file" id="fileInput" class="d-none" accept=".pdf" multiple>
                        <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('fileInput').click()">
                            <i data-feather="folder" class="me-2"></i>Browse Files
                        </button>
                        <div class="mt-3">
                            <small class="text-muted">Maximum file size: 50MB per file</small>
                        </div>
                    </div>

                    <!-- Selected Files -->
                    <div id="selectedFiles" class="mb-4" style="display: none;">
                        <h6>Selected Files:</h6>
                        <div id="fileList" class="list-group"></div>
                    </div>

                    <!-- Operation Options -->
                    <div id="operationOptions" style="display: none;">
                        <!-- Split Options -->
                        <div id="splitOptions" class="mb-4" style="display: none;">
                            <h6>Split Options:</h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Start Page</label>
                                    <input type="number" class="form-control" id="splitStart" min="1" placeholder="1">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">End Page</label>
                                    <input type="number" class="form-control" id="splitEnd" min="1" placeholder="Last page">
                                </div>
                            </div>
                        </div>

                        <!-- Convert Options -->
                        <div id="convertOptions" class="mb-4" style="display: none;">
                            <h6>Conversion Options:</h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Output Format</label>
                                    <select class="form-select" id="convertFormat">
                                        <option value="PNG">PNG</option>
                                        <option value="JPEG">JPEG</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">DPI Quality</label>
                                    <select class="form-select" id="convertDpi">
                                        <option value="150">150 DPI (Standard)</option>
                                        <option value="300" selected>300 DPI (High)</option>
                                        <option value="600">600 DPI (Print)</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Compress Options -->
                        <div id="compressOptions" class="mb-4" style="display: none;">
                            <h6>Compression Options:</h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Quality Level</label>
                                    <select class="form-select" id="compressQuality">
                                        <option value="low">Low (Maximum Compression)</option>
                                        <option value="medium" selected>Medium (Balanced)</option>
                                        <option value="high">High (Minimal Compression)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Process Button -->
                    <div class="d-grid">
                        <button type="button" id="processBtn" class="btn btn-primary btn-lg" disabled>
                            <i data-feather="play" class="me-2"></i>Process Files
                        </button>
                    </div>
                </div>
            </div>

            <!-- Processing Status -->
            <div id="processingStatus" class="card border-0 shadow-sm mt-4" style="display: none;">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i data-feather="clock" class="me-2"></i>Processing Status
                    </h5>
                </div>
                <div class="card-body">
                    <div id="statusContent">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-3" role="status"></div>
                            <span>Processing your files...</span>
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="progress">
                            <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results -->
            <div id="resultsSection" class="card border-0 shadow-sm mt-4" style="display: none;">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i data-feather="download" class="me-2"></i>Results
                    </h5>
                </div>
                <div class="card-body">
                    <div id="resultsContent"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let selectedOperation = '';
    let selectedFiles = [];
    let currentJobId = null;
    
    // Set API key
    window.pdfAPI.setApiKey('{{ current_user.api_key }}');
    
    // Operation selection
    document.querySelectorAll('.operation-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Remove active state from all buttons
            document.querySelectorAll('.operation-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            selectedOperation = this.dataset.operation;
            updateOperationDisplay();
            updateProcessButton();
        });
    });
    
    // Auto-select operation from URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const operation = urlParams.get('operation');
    if (operation) {
        const btn = document.querySelector(`[data-operation="${operation}"]`);
        if (btn) {
            btn.click();
        }
    }
    
    function updateOperationDisplay() {
        const badge = document.getElementById('operationBadge');
        const instructions = document.getElementById('operationInstructions');
        const instructionContent = document.getElementById('instructionContent');
        const operationOptions = document.getElementById('operationOptions');
        const fileInput = document.getElementById('fileInput');
        
        const operationConfig = {
            merge: {
                title: 'Merge PDFs',
                badge: 'bg-primary',
                instruction: 'Select multiple PDF files to combine them into a single document.',
                multiple: true,
                showOptions: false
            },
            split: {
                title: 'Split PDF',
                badge: 'bg-success',
                instruction: 'Select a single PDF file to split into individual pages or extract specific page ranges.',
                multiple: false,
                showOptions: true
            },
            convert: {
                title: 'Convert to Images',
                badge: 'bg-warning',
                instruction: 'Select PDF files to convert each page into high-quality images.',
                multiple: true,
                showOptions: true
            },
            compress: {
                title: 'Compress PDF',
                badge: 'bg-danger',
                instruction: 'Select PDF files to reduce their file size while maintaining quality.',
                multiple: true,
                showOptions: true
            },
            metadata: {
                title: 'Extract Metadata',
                badge: 'bg-info',
                instruction: 'Select PDF files to extract document properties and metadata.',
                multiple: true,
                showOptions: false
            }
        };
        
        const config = operationConfig[selectedOperation];
        if (config) {
            badge.textContent = config.title;
            badge.className = `badge ${config.badge}`;
            instructionContent.textContent = config.instruction;
            instructions.style.display = 'block';
            
            // Update file input
            fileInput.multiple = config.multiple;
            
            // Show/hide operation options
            operationOptions.style.display = config.showOptions ? 'block' : 'none';
            
            // Show specific options
            document.getElementById('splitOptions').style.display = selectedOperation === 'split' ? 'block' : 'none';
            document.getElementById('convertOptions').style.display = selectedOperation === 'convert' ? 'block' : 'none';
            document.getElementById('compressOptions').style.display = selectedOperation === 'compress' ? 'block' : 'none';
        }
    }
    
    // File upload handling
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    
    // Create drop zone
    const dropZone = new DropZone(uploadArea, handleFileDrop);
    
    fileInput.addEventListener('change', function() {
        handleFiles(Array.from(this.files));
    });
    
    function handleFileDrop(files) {
        handleFiles(files);
    }
    
    function handleFiles(files) {
        selectedFiles = [];
        
        files.forEach(file => {
            if (file.type === 'application/pdf') {
                selectedFiles.push(file);
            } else {
                UIHelpers.showAlert(`File "${file.name}" is not a PDF file.`, 'warning');
            }
        });
        
        updateFileList();
        updateProcessButton();
    }
    
    function updateFileList() {
        const selectedFilesDiv = document.getElementById('selectedFiles');
        const fileList = document.getElementById('fileList');
        
        if (selectedFiles.length > 0) {
            selectedFilesDiv.style.display = 'block';
            fileList.innerHTML = '';
            
            selectedFiles.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'list-group-item d-flex justify-content-between align-items-center';
                item.innerHTML = `
                    <div>
                        <i data-feather="file-text" class="me-2"></i>
                        <span>${file.name}</span>
                        <small class="text-muted ms-2">(${UIHelpers.formatFileSize(file.size)})</small>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFile(${index})">
                        <i data-feather="x" style="width: 14px; height: 14px;"></i>
                    </button>
                `;
                fileList.appendChild(item);
            });
            
            // Re-initialize feather icons
            feather.replace();
        } else {
            selectedFilesDiv.style.display = 'none';
        }
    }
    
    window.removeFile = function(index) {
        selectedFiles.splice(index, 1);
        updateFileList();
        updateProcessButton();
    };
    
    function updateProcessButton() {
        const processBtn = document.getElementById('processBtn');
        const canProcess = selectedOperation && selectedFiles.length > 0;
        
        processBtn.disabled = !canProcess;
        
        if (canProcess) {
            processBtn.innerHTML = `<i data-feather="play" class="me-2"></i>Process ${selectedFiles.length} File${selectedFiles.length > 1 ? 's' : ''}`;
        } else {
            processBtn.innerHTML = `<i data-feather="play" class="me-2"></i>Process Files`;
        }
        
        feather.replace();
    }
    
    // Process button handler
    document.getElementById('processBtn').addEventListener('click', async function() {
        if (!selectedOperation || selectedFiles.length === 0) return;
        
        const processingStatus = document.getElementById('processingStatus');
        const resultsSection = document.getElementById('resultsSection');
        
        processingStatus.style.display = 'block';
        resultsSection.style.display = 'none';
        
        try {
            let result;
            
            switch (selectedOperation) {
                case 'merge':
                    result = await window.pdfAPI.mergePDFs(selectedFiles);
                    break;
                case 'split':
                    const startPage = document.getElementById('splitStart').value || null;
                    const endPage = document.getElementById('splitEnd').value || null;
                    const pages = (startPage && endPage) ? `${startPage}-${endPage}` : null;
                    result = await window.pdfAPI.splitPDF(selectedFiles[0], pages);
                    break;
                case 'convert':
                    const format = document.getElementById('convertFormat').value;
                    const dpi = parseInt(document.getElementById('convertDpi').value);
                    result = await window.pdfAPI.convertToImages(selectedFiles[0], format, dpi);
                    break;
                case 'compress':
                    const quality = document.getElementById('compressQuality').value;
                    result = await window.pdfAPI.compressPDF(selectedFiles[0], quality);
                    break;
                case 'metadata':
                    result = await window.pdfAPI.extractMetadata(selectedFiles[0]);
                    break;
            }
            
            currentJobId = result.job_id;
            
            // Start monitoring job status
            window.jobMonitor.addJob(currentJobId);
            monitorJobProgress();
            
        } catch (error) {
            processingStatus.style.display = 'none';
            UIHelpers.showAlert(`Error: ${error.message}`, 'danger');
        }
    });
    
    async function monitorJobProgress() {
        if (!currentJobId) return;
        
        try {
            const status = await window.pdfAPI.getJobStatus(currentJobId);
            updateProgressDisplay(status);
            
            if (status.status === 'completed') {
                showResults(status);
                window.jobMonitor.removeJob(currentJobId);
            } else if (status.status === 'failed') {
                showError(status);
                window.jobMonitor.removeJob(currentJobId);
            } else {
                // Continue monitoring
                setTimeout(monitorJobProgress, 2000);
            }
        } catch (error) {
            console.error('Error monitoring job:', error);
            UIHelpers.showAlert(`Error monitoring job: ${error.message}`, 'danger');
        }
    }
    
    function updateProgressDisplay(status) {
        const statusContent = document.getElementById('statusContent');
        const progressBar = document.getElementById('progressBar');
        
        let progress = 0;
        if (status.status === 'processing') progress = 50;
        if (status.status === 'completed') progress = 100;
        
        progressBar.style.width = `${progress}%`;
        
        statusContent.innerHTML = `
            <div class="d-flex align-items-center">
                ${status.status !== 'completed' ? '<div class="spinner-border spinner-border-sm me-3" role="status"></div>' : ''}
                <span>Job ${status.status}... (ID: ${status.job_id})</span>
            </div>
        `;
    }
    
    function showResults(status) {
        const processingStatus = document.getElementById('processingStatus');
        const resultsSection = document.getElementById('resultsSection');
        const resultsContent = document.getElementById('resultsContent');
        
        processingStatus.style.display = 'none';
        resultsSection.style.display = 'block';
        
        if (selectedOperation === 'metadata') {
            // Show metadata results
            resultsContent.innerHTML = `
                <div class="alert alert-success">
                    <h6><i data-feather="check-circle" class="me-2"></i>Metadata Extracted Successfully</h6>
                    <pre class="mt-3 bg-dark text-light p-3 rounded">${JSON.stringify(status.metadata || {}, null, 2)}</pre>
                </div>
            `;
        } else {
            // Show download links
            const outputFiles = status.output_files || [];
            resultsContent.innerHTML = `
                <div class="alert alert-success">
                    <h6><i data-feather="check-circle" class="me-2"></i>Processing Completed Successfully</h6>
                </div>
                <div class="d-flex gap-2 flex-wrap">
                    ${outputFiles.map(file => `
                        <button class="btn btn-outline-primary" onclick="window.pdfAPI.downloadFile('${file}')">
                            <i data-feather="download" class="me-2"></i>Download ${file}
                        </button>
                    `).join('')}
                </div>
            `;
        }
        
        feather.replace();
    }
    
    function showError(status) {
        const processingStatus = document.getElementById('processingStatus');
        
        processingStatus.style.display = 'none';
        UIHelpers.showAlert(`Processing failed: ${status.error || 'Unknown error'}`, 'danger');
    }
});
</script>
{% endblock %}